<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/lecturer-layout :: head(title=${pageTitle})}">
    <title th:text="${pageTitle} + ' - Dikoding Muda Nusantara'">Buat Kursus - Dikoding Muda Nusantara</title>
</head>
<!-- Page Specific Styles -->
<style>
    .content-area {
        max-width: 900px;
    }

    /* Form Actions */
    .form-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--color-border);
    }

    /* Price Input */
    .price-input-wrapper {
        position: relative;
    }

    .price-prefix {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.9375rem;
        color: var(--color-text-muted);
    }

    .price-input {
        padding-left: 2.75rem;
    }

    /* Toggle Switch */
    .toggle-wrapper {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-sm);
    }

    .toggle-label {
        font-size: 0.9375rem;
        font-weight: 500;
    }

    .toggle-desc {
        font-size: 0.8125rem;
        color: var(--color-text-muted);
        margin-top: 0.25rem;
    }

    .toggle-switch {
        position: relative;
        width: 48px;
        height: 26px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--color-border);
        transition: var(--transition);
        border-radius: 26px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 3px;
        bottom: 3px;
        background: white;
        transition: var(--transition);
        border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
        background: var(--color-primary);
    }

    .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(22px);
    }

    /* Thumbnail Upload */
    .thumbnail-upload {
        border: 2px dashed var(--color-border);
        border-radius: var(--radius-md);
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: var(--transition);
    }

    .thumbnail-upload:hover {
        border-color: var(--color-primary);
        background: var(--color-primary-light);
    }

    .thumbnail-upload input {
        display: none;
    }

    .thumbnail-icon {
        width: 48px;
        height: 48px;
        background: var(--color-bg-subtle);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        color: var(--color-text-muted);
    }

    .thumbnail-text {
        font-size: 0.9375rem;
        margin-bottom: 0.25rem;
    }

    .thumbnail-text span {
        color: var(--color-primary);
        font-weight: 600;
    }

    .thumbnail-hint {
        font-size: 0.8125rem;
        color: var(--color-text-muted);
    }

    .thumbnail-preview {
        width: 100%;
        max-height: 200px;
        object-fit: cover;
        border-radius: var(--radius-sm);
        margin-top: 1rem;
    }

    /* Upload Progress */
    .upload-progress {
        margin-top: 0.5rem;
        display: none;
    }

    .upload-progress.show {
        display: block;
    }

    .progress-bar-custom {
        height: 6px;
        background: var(--color-border);
        border-radius: 3px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: var(--color-primary);
        width: 0%;
        transition: width 0.3s;
    }

    /* Section Builder */
    .section-builder {
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
    }

    .section-item {
        border-bottom: 1px solid var(--color-border);
    }

    .section-item:last-child {
        border-bottom: none;
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 1.25rem;
        background: var(--color-bg-subtle);
        cursor: pointer;
    }

    .section-header:hover {
        background: #f3f4f6;
    }

    .section-drag {
        color: var(--color-text-muted);
        cursor: grab;
    }

    .section-toggle {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--color-text-muted);
        transition: var(--transition);
    }

    .section-toggle.open {
        transform: rotate(180deg);
    }

    .section-title-input {
        flex: 1;
        padding: 0.5rem 0.75rem;
        border: 1px solid transparent;
        border-radius: var(--radius-sm);
        font-size: 0.9375rem;
        font-weight: 600;
        background: transparent;
        font-family: inherit;
    }

    .section-title-input:focus {
        outline: none;
        border-color: var(--color-primary);
        background: var(--color-bg);
    }

    .section-actions {
        display: flex;
        gap: 0.5rem;
    }

    .section-action-btn {
        width: 32px;
        height: 32px;
        border-radius: var(--radius-sm);
        border: none;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--color-text-muted);
        transition: var(--transition);
    }

    .section-action-btn:hover {
        background: var(--color-bg);
        color: var(--color-text);
    }

    .section-action-btn.delete:hover {
        background: var(--color-error-light);
        color: var(--color-error);
    }

    .section-content {
        padding: 1.25rem;
        display: none;
    }

    .section-content.open {
        display: block;
    }

    /* Lesson Item */
    .lesson-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-sm);
        margin-bottom: 0.5rem;
        background: var(--color-bg);
    }

    .lesson-item:hover {
        border-color: var(--color-primary);
    }

    .lesson-drag {
        color: var(--color-text-muted);
        cursor: grab;
    }

    .lesson-type {
        width: 32px;
        height: 32px;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .lesson-type.video {
        background: var(--color-primary-light);
        color: var(--color-primary);
    }

    .lesson-type.text {
        background: var(--color-success-light);
        color: var(--color-success);
    }

    .lesson-type.pdf {
        background: var(--color-error-light);
        color: var(--color-error);
    }

    .lesson-type.quiz {
        background: var(--color-warning-light);
        color: var(--color-warning);
    }

    .lesson-info {
        flex: 1;
    }

    .lesson-title {
        font-size: 0.875rem;
        font-weight: 500;
    }

    .lesson-meta {
        font-size: 0.75rem;
        color: var(--color-text-muted);
    }

    .lesson-actions {
        display: flex;
        gap: 0.25rem;
    }

    /* Add Buttons */
    .btn-add-lesson {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        width: 100%;
        padding: 0.75rem;
        border: 1px dashed var(--color-border);
        border-radius: var(--radius-sm);
        background: transparent;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--color-text-secondary);
        cursor: pointer;
        font-family: inherit;
        transition: var(--transition);
    }

    .btn-add-lesson:hover {
        border-color: var(--color-primary);
        color: var(--color-primary);
        background: var(--color-primary-light);
    }

    .btn-add-section {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        width: 100%;
        padding: 1rem;
        border: 2px dashed var(--color-border);
        border-radius: var(--radius-md);
        background: transparent;
        font-size: 0.9375rem;
        font-weight: 600;
        color: var(--color-text-secondary);
        cursor: pointer;
        margin-top: 1rem;
        font-family: inherit;
        transition: var(--transition);
    }

    .btn-add-section:hover {
        border-color: var(--color-primary);
        color: var(--color-primary);
        background: var(--color-primary-light);
    }

    /* Lesson Type Selector */
    .lesson-type-selector {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .lesson-type-option {
        padding: 1rem;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-sm);
        text-align: center;
        cursor: pointer;
        transition: var(--transition);
    }

    .lesson-type-option:hover {
        border-color: var(--color-primary);
    }

    .lesson-type-option.active {
        border-color: var(--color-primary);
        background: var(--color-primary-light);
    }

    .lesson-type-option input {
        display: none;
    }

    .lesson-type-option .lesson-type-icon {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 0.5rem;
    }

    .lesson-type-option.video .lesson-type-icon {
        background: var(--color-primary-light);
        color: var(--color-primary);
    }

    .lesson-type-option.text .lesson-type-icon {
        background: var(--color-success-light);
        color: var(--color-success);
    }

    .lesson-type-option.pdf .lesson-type-icon {
        background: var(--color-error-light);
        color: var(--color-error);
    }

    .lesson-type-option.quiz .lesson-type-icon {
        background: var(--color-warning-light);
        color: var(--color-warning);
    }

    .lesson-type-name {
        font-size: 0.875rem;
        font-weight: 600;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .lesson-type-selector {
            grid-template-columns: repeat(2, 1fr);
        }

        .form-actions {
            flex-direction: column;
        }

        .form-actions .btn {
            width: 100%;
        }
    }
</style>
<body>

<div class="dashboard-layout">
    <!-- Sidebar -->
    <aside th:replace="~{fragments/lecturer-layout :: sidebar(activeMenu='create-course')}"></aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Header with Back Button -->
        <header th:replace="~{fragments/lecturer-layout :: topHeaderWithBack(pageTitle=${pageTitle}, backUrl='/lecturer/courses')}"></header>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Alert Messages -->
            <div th:if="${successMessage}" class="alert alert-success">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                <span th:text="${successMessage}">Berhasil</span>
            </div>
            
            <div th:if="${errorMessage}" class="alert alert-danger">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="15" y1="9" x2="9" y2="15"/>
                    <line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
                <span th:text="${errorMessage}">Terjadi kesalahan</span>
            </div>

            <!-- Course Form -->
            <form id="courseForm" th:action="@{/lecturer/courses/save}" th:object="${courseDTO}" method="POST"> 
                <input type="hidden" th:field="*{courseId}">
                <input type="hidden" th:field="*{existingThumbnailUrl}" id="existingThumbnailUrl">
                <input type="hidden" name="sectionsJson" id="sectionsJsonInput">

                <!-- Basic Information -->
                <div class="form-section">
                    <div class="form-section-header">
                        <h2 class="form-section-title">Informasi Dasar</h2>
                        <p class="form-section-desc">Masukkan informasi utama tentang kursus Anda</p>
                    </div>
                    <div class="form-section-body">
                        <div class="form-group">
                            <label class="form-label" for="title">Judul Kursus <span class="required">*</span></label>
                            <input type="text" class="form-input" th:classappend="${#fields.hasErrors('title')} ? ' is-invalid' : ''" 
                                   id="title" th:field="*{title}" placeholder="Contoh: Belajar JavaScript dari Nol" required>
                            <p class="invalid-feedback" th:if="${#fields.hasErrors('title')}" th:errors="*{title}">Error</p>
                            <p class="form-hint">Judul yang jelas akan meningkatkan minat pelajar</p>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="shortDescription">Deskripsi Singkat</label>
                            <input type="text" class="form-input" id="shortDescription" th:field="*{shortDescription}" 
                                   placeholder="Ringkasan singkat (maks 500 karakter)" maxlength="500">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="description">Deskripsi Lengkap <span class="required">*</span></label>
                            <textarea class="form-input form-textarea" th:classappend="${#fields.hasErrors('description')} ? ' is-invalid' : ''" 
                                      id="description" th:field="*{description}" placeholder="Jelaskan apa yang akan dipelajari..." required></textarea>
                            <p class="invalid-feedback" th:if="${#fields.hasErrors('description')}" th:errors="*{description}">Error</p>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="categoryId">Kategori <span class="required">*</span></label>
                                <select class="form-input form-select" th:classappend="${#fields.hasErrors('categoryId')} ? ' is-invalid' : ''" 
                                        id="categoryId" th:field="*{categoryId}" required>
                                    <option value="">Pilih Kategori</option>
                                    <option th:each="cat : ${categories}" th:value="${cat.categoryId}" th:text="${cat.name}">Kategori</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="level">Level <span class="required">*</span></label>
                                <select class="form-input form-select" th:classappend="${#fields.hasErrors('level')} ? ' is-invalid' : ''" 
                                        id="level" th:field="*{level}" required>
                                    <option value="">Pilih Level</option>
                                    <option value="beginner">Pemula</option>
                                    <option value="intermediate">Menengah</option>
                                    <option value="advanced">Mahir</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Thumbnail Kursus</label>
                            <label class="thumbnail-upload" id="thumbnailDropzone">
                                <input type="file" id="thumbnailInput" accept="image/*">
                                <div class="thumbnail-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <polyline points="21 15 16 10 5 21"/>
                                    </svg>
                                </div>
                                <p class="thumbnail-text"><span>Klik untuk upload</span></p>
                                <p class="thumbnail-hint">PNG, JPG hingga 2MB</p>
                            </label>
                            <div class="upload-progress" id="thumbnailProgress">
                                <div class="progress-bar-custom">
                                    <div class="progress-fill" id="thumbnailProgressBar"></div>
                                </div>
                                <small class="text-muted">Mengupload...</small>
                            </div>
                            <img id="thumbnailPreview"
                                class="thumbnail-preview"
                                th:src="${courseDTO.existingThumbnailUrl != null} 
                                         ? @{/files/view(path=${courseDTO.existingThumbnailUrl})} 
                                         : ''"
                                th:style="${courseDTO.existingThumbnailUrl != null} 
                                           ? 'display:block' 
                                           : 'display:none'"
                                alt="Preview">
                        </div>
                    </div>
                </div>

                <!-- Pricing -->
                <div class="form-section">
                    <div class="form-section-header">
                        <h2 class="form-section-title">Harga</h2>
                        <p class="form-section-desc">Tentukan harga untuk kursus Anda</p>
                    </div>
                    <div class="form-section-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="price">Harga <span class="required">*</span></label>
                                <div class="price-input-wrapper">
                                    <span class="price-prefix">Rp</span>
                                    <input type="number" class="form-input price-input" id="price" th:field="*{price}" 
                                           placeholder="0" min="0" required>
                                </div>
                                <p class="form-hint">Masukkan 0 untuk kursus gratis</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="discountPrice">Harga Diskon</label>
                                <div class="price-input-wrapper">
                                    <span class="price-prefix">Rp</span>
                                    <input type="number" class="form-input price-input" id="discountPrice" th:field="*{discountPrice}" 
                                           placeholder="0" min="0">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="toggle-wrapper">
                                <div>
                                    <div class="toggle-label">Kursus Gratis</div>
                                    <div class="toggle-desc">Aktifkan jika kursus ini gratis</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" th:field="*{isFree}" onchange="toggleFreePrice(this)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Curriculum -->
                <div class="form-section">
                    <div class="form-section-header">
                        <h2 class="form-section-title">Kurikulum</h2>
                        <p class="form-section-desc">Susun materi pembelajaran</p>
                    </div>
                    <div class="form-section-body">
                        <div class="section-builder" id="sectionBuilder">
                            <th:block th:each="section, sectionStat : ${courseDTO.sections}">
                                <div class="section-item" th:data-section="${sectionStat.index}">
                                    <div class="section-header" th:onclick="'toggleSection(' + ${sectionStat.index} + ')'">
                                        <span class="section-drag">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/>
                                                <circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/>
                                            </svg>
                                        </span>
                                        <span class="section-toggle open" th:id="'toggle-' + ${sectionStat.index}">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="m6 9 6 6 6-6"/>
                                            </svg>
                                        </span>
                                        <input type="text" class="section-title-input" th:value="${section.title}" 
                                               th:data-section-id="${section.sectionId}" onclick="event.stopPropagation()">
                                        <div class="section-actions" onclick="event.stopPropagation()">
                                            <button type="button" class="section-action-btn delete" th:onclick="'deleteSection(' + ${sectionStat.index} + ')'">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="section-content open" th:id="'content-' + ${sectionStat.index}">
                                        <div class="lesson-list" th:id="'lessons-' + ${sectionStat.index}">
                                            <th:block th:each="lesson, lessonStat : ${section.lessons}">
                                                <div class="lesson-item" th:data-lesson-id="${lesson.lessonId}">
                                                    <span class="lesson-drag">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/>
                                                            <circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/>
                                                        </svg>
                                                    </span>
                                                    <div th:class="'lesson-type ' + ${lesson.contentType.toLowerCase()}">
                                                        <svg th:if="${lesson.contentType == 'video'}" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                                                        <svg th:if="${lesson.contentType == 'text'}" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                                                        <svg th:if="${lesson.contentType == 'pdf'}" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                                                        <svg th:if="${lesson.contentType == 'quiz'}" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                                    </div>
                                                    <div class="lesson-info">
                                                        <div class="lesson-title" th:text="${lesson.title}">Judul Lesson</div>
                                                        <div class="lesson-meta" th:text="${lesson.duration} + ' menit'">0 menit</div>
                                                    </div>
                                                    <div class="lesson-actions">
                                                        <button type="button" class="section-action-btn delete" onclick="this.closest('.lesson-item').remove(); updateSectionsJson();">
                                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                                <path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </div>
                                            </th:block>
                                        </div>
                                        <button type="button" class="btn-add-lesson" th:onclick="'showAddLessonModal(' + ${sectionStat.index} + ')'">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M12 5v14"/><path d="M5 12h14"/>
                                            </svg>
                                            Tambah Materi
                                        </button>
                                    </div>
                                </div>
                            </th:block>
                        </div>
                        <button type="button" class="btn-add-section" onclick="addSection()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14"/><path d="M5 12h14"/>
                            </svg>
                            Tambah Section Baru
                        </button>
                    </div>
                </div>
                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="window.history.back()">Batal</button>
                    <button type="submit" name="action" value="draft" class="btn btn-secondary">Simpan sebagai Draft</button>
                    <button type="submit" name="action" value="publish" class="btn btn-primary-custom">
                        <span th:text="${isEdit} ? 'Simpan Perubahan' : 'Publish Kursus'">Publish Kursus</span>
                    </button>
                </div>
            </form>
        </div>
    </main>
</div>

<!-- Add Lesson Modal -->
<div class="modal-backdrop" id="lessonModal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 class="modal-title">Tambah Materi Baru</h3>
            <button type="button" class="modal-close" onclick="hideAddLessonModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="lesson-type-selector">
                <label class="lesson-type-option video active">
                    <input type="radio" name="lessonType" value="video" checked>
                    <div class="lesson-type-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="5 3 19 12 5 21 5 3"/>
                        </svg>
                    </div>
                    <div class="lesson-type-name">Video</div>
                </label>
                <label class="lesson-type-option text" onclick="selectLessonType('text')">
                    <input type="radio" name="lessonType" value="text">
                    <div class="lesson-type-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                    </div>
                    <div class="lesson-type-name">Artikel</div>
                </label>
                <label class="lesson-type-option pdf" onclick="selectLessonType('pdf')">
                    <input type="radio" name="lessonType" value="pdf">
                    <div class="lesson-type-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                    </div>
                    <div class="lesson-type-name">PDF</div>
                </label>
                <label class="lesson-type-option quiz" onclick="selectLessonType('quiz')">
                    <input type="radio" name="lessonType" value="quiz">
                    <div class="lesson-type-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                    </div>
                    <div class="lesson-type-name">Quiz</div>
                </label>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="lessonTitle">Judul Materi <span class="required">*</span></label>
                <input type="text" class="form-input" id="lessonTitle" placeholder="Contoh: Pengenalan JavaScript">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="lessonDescription">Deskripsi</label>
                <textarea class="form-input form-textarea" id="lessonDescription" placeholder="Deskripsi singkat tentang materi ini" rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="lessonDuration">Durasi (menit)</label>
                <input type="number" class="form-input" id="lessonDuration" placeholder="0" min="0">
            </div>
            
            <div id="lessonContentContainer"></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="hideAddLessonModal()">Batal</button>
            <button type="button" class="btn btn-primary-custom" onclick="addLesson()">Tambah Materi</button>
        </div>
    </div>
</div>

<!-- Scripts -->
<th:block th:replace="~{fragments/lecturer-layout :: scripts}"></th:block>

<script th:inline="javascript">
    let sectionCount = [[${courseDTO.sections != null ? courseDTO.sections.size() : 0}]];
    let currentSectionIndex = 0;
    let currentLessonContentUrl = '';
    let currentLessonContentText = '';
    
    function toggleFreePrice(checkbox) {
        var priceInput = document.getElementById('price');
        var discountInput = document.getElementById('discountPrice');
        if (checkbox.checked) {
            priceInput.value = 0;
            priceInput.disabled = true;
            discountInput.value = '';
            discountInput.disabled = true;
        } else {
            priceInput.disabled = false;
            discountInput.disabled = false;
        }
    }
    
    function toggleSection(idx) { 
        document.getElementById('content-' + idx).classList.toggle('open'); 
        document.getElementById('toggle-' + idx).classList.toggle('open'); 
    }
    
    function deleteSection(idx) { 
        if(confirm('Hapus section ini?')) {
            document.querySelector('[data-section="'+idx+'"]').remove(); 
            updateSectionsJson(); 
        }
    }
    
    function addSection() {
        sectionCount++;
        const html = `<div class="section-item" data-section="${sectionCount}">
            <div class="section-header" onclick="toggleSection(${sectionCount})">
                <span class="section-drag"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg></span>
                <span class="section-toggle open" id="toggle-${sectionCount}"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></span>
                <input type="text" class="section-title-input" value="Section ${sectionCount}: Judul" onclick="event.stopPropagation()">
                <div class="section-actions" onclick="event.stopPropagation()">
                    <button type="button" class="section-action-btn delete" onclick="deleteSection(${sectionCount})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                </div>
            </div>
            <div class="section-content open" id="content-${sectionCount}">
                <div class="lesson-list" id="lessons-${sectionCount}"></div>
                <button type="button" class="btn-add-lesson" onclick="showAddLessonModal(${sectionCount})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"/><path d="M5 12h14"/></svg>Tambah Materi</button>
            </div>
        </div>`;
        document.getElementById('sectionBuilder').insertAdjacentHTML('beforeend', html);
        updateSectionsJson();
    }
    
    function showAddLessonModal(idx) { 
        currentSectionIndex = idx; 
        currentLessonContentUrl = '';
        currentLessonContentText = '';
        document.getElementById('lessonTitle').value = ''; 
        document.getElementById('lessonDescription').value = ''; 
        document.getElementById('lessonDuration').value = ''; 
        selectLessonType('video');
        document.getElementById('lessonModal').classList.add('show'); 
    }
    
    function hideAddLessonModal() { 
        document.getElementById('lessonModal').classList.remove('show'); 
        currentLessonContentUrl = '';
        currentLessonContentText = '';
    }
    
    function selectLessonType(type) { 
        document.querySelectorAll('.lesson-type-option').forEach(o => o.classList.remove('active'));
        document.querySelector('.lesson-type-option.' + type).classList.add('active');
        document.querySelector('input[name="lessonType"][value="' + type + '"]').checked = true;
        
        currentLessonContentUrl = '';
        currentLessonContentText = '';
        
        let contentContainer = document.getElementById('lessonContentContainer');
        if (!contentContainer) {
            contentContainer = document.createElement('div');
            contentContainer.id = 'lessonContentContainer';
            contentContainer.className = 'form-group';
            document.getElementById('lessonDuration').closest('.form-group').after(contentContainer);
        }
        
        if (type === 'video') {
            contentContainer.innerHTML = `
                <label class="form-label">URL Video</label>
                <input type="text" class="form-input" id="lessonVideoUrl" placeholder="https://youtube.com/... atau upload file">
                <p class="form-hint">Masukkan URL YouTube atau Vimeo</p>`;
        } else if (type === 'text') {
            contentContainer.innerHTML = `
                <label class="form-label">Konten Artikel <span class="required">*</span></label>
                <textarea class="form-input form-textarea" id="lessonTextContent" placeholder="Tulis konten artikel di sini..." rows="8"></textarea>`;
        } else if (type === 'pdf') {
            contentContainer.innerHTML = `
                <label class="form-label">URL File PDF</label>
                <input type="text" class="form-input" id="lessonPdfUrl" placeholder="URL ke file PDF">`;
        } else if (type === 'quiz') {
            contentContainer.innerHTML = `
                <p class="form-hint">Quiz akan dikonfigurasi setelah kursus dibuat</p>`;
        }
    }
    
    function addLesson() {
        var title = document.getElementById('lessonTitle').value;
        if (!title) { alert('Judul materi harus diisi'); return; }
        
        var type = document.querySelector('input[name="lessonType"]:checked').value;
        var duration = document.getElementById('lessonDuration').value || 0;
        var description = document.getElementById('lessonDescription').value || '';
        
        var contentUrl = '';
        var contentText = '';
        
        if (type === 'video' && document.getElementById('lessonVideoUrl')) {
            contentUrl = document.getElementById('lessonVideoUrl').value;
        } else if (type === 'text' && document.getElementById('lessonTextContent')) {
            contentText = document.getElementById('lessonTextContent').value;
        } else if (type === 'pdf' && document.getElementById('lessonPdfUrl')) {
            contentUrl = document.getElementById('lessonPdfUrl').value;
        }
        
        var lessonHtml = `<div class="lesson-item" data-content-url="${contentUrl}" data-content-text="${encodeURIComponent(contentText)}" data-description="${encodeURIComponent(description)}">
            <span class="lesson-drag"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg></span>
            <div class="lesson-type ${type}">
                ${type === 'video' ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>' : ''}
                ${type === 'text' ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>' : ''}
                ${type === 'pdf' ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>' : ''}
                ${type === 'quiz' ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>' : ''}
            </div>
            <div class="lesson-info">
                <div class="lesson-title">${title}</div>
                <div class="lesson-meta">${duration} menit</div>
            </div>
            <div class="lesson-actions">
                <button type="button" class="section-action-btn delete" onclick="this.closest('.lesson-item').remove(); updateSectionsJson();"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
            </div>
        </div>`;
        
        document.getElementById('lessons-' + currentSectionIndex).insertAdjacentHTML('beforeend', lessonHtml);
        hideAddLessonModal();
        updateSectionsJson();
    }
    
    function updateSectionsJson() {
        var sections = [];
        document.querySelectorAll('.section-item').forEach((section, sIdx) => {
            var sectionData = {
                sectionId: section.querySelector('.section-title-input').dataset.sectionId || null,
                title: section.querySelector('.section-title-input').value,
                sortOrder: sIdx,
                lessons: []
            };
            section.querySelectorAll('.lesson-item').forEach((lesson, lIdx) => {
                var typeEl = lesson.querySelector('.lesson-type');
                var type = 'video';
                if (typeEl.classList.contains('text')) type = 'text';
                else if (typeEl.classList.contains('pdf')) type = 'pdf';
                else if (typeEl.classList.contains('quiz')) type = 'quiz';
                
                sectionData.lessons.push({
                    lessonId: lesson.dataset.lessonId || null,
                    title: lesson.querySelector('.lesson-title').textContent,
                    contentType: type,
                    contentUrl: lesson.dataset.contentUrl || '',
                    contentText: decodeURIComponent(lesson.dataset.contentText || ''),
                    description: decodeURIComponent(lesson.dataset.description || ''),
                    duration: parseInt(lesson.querySelector('.lesson-meta').textContent) || 0,
                    sortOrder: lIdx
                });
            });
            sections.push(sectionData);
        });
        document.getElementById('sectionsJsonInput').value = JSON.stringify(sections);
    }
    
    // Thumbnail upload
    document.getElementById('thumbnailInput').addEventListener('change', function(e) {
        var file = e.target.files[0];
        if (!file) return;
        
        var formData = new FormData();
        formData.append('file', file);
        
        var progress = document.getElementById('thumbnailProgress');
        var progressBar = document.getElementById('thumbnailProgressBar');
        progress.classList.add('show');
        
        var xhr = new XMLHttpRequest();
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                var pct = (e.loaded / e.total) * 100;
                progressBar.style.width = pct + '%';
            }
        });
        
        xhr.addEventListener('load', function() {
            progress.classList.remove('show');
            if (xhr.status === 200) {
                try {
                    var response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        document.getElementById('existingThumbnailUrl').value = response.data.path;
                        document.getElementById('thumbnailPreview').src = '/files/view?path=' + response.data.path;
                        document.getElementById('thumbnailPreview').style.display = 'block';
                    } else {
                        console.log("Error message "+response.message);
                        alert('Upload gagal: ' + response.message);
                    }
                } catch(e) {
                    console.log(e);
                    alert('Upload gagal');
                }
            } else {
                console.log("Gagal kenapa?");
                alert('Upload gagal');
            }
        });
        
        xhr.addEventListener('error', function() {
            progress.classList.remove('show');
            alert('Upload error');
        });
        
        xhr.open('POST', '/files/upload/thumbnail');
        xhr.send(formData);
    });
    
    // Update sectionsJson before submit
    document.getElementById('courseForm').addEventListener('submit', function(e) {
        updateSectionsJson();
    });
    
    // Close modal on backdrop click
    document.getElementById('lessonModal').addEventListener('click', function(e) { 
        if(e.target.id === 'lessonModal') hideAddLessonModal(); 
    });
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() { 
        updateSectionsJson(); 
        if(document.querySelector('input[name="isFree"]')?.checked) {
            toggleFreePrice(document.querySelector('input[name="isFree"]')); 
        }
    });
</script>
</body>
</html>