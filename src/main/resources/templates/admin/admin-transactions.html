<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaksi - Admin Dikoding Muda</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
    <link rel="stylesheet" th:href="@{/css/admin-dashboard.css}" />
</head>
<body>
    <div class="admin-layout">
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        <th:block th:replace="~{admin/fragments/admin-sidebar :: sidebar('transactions')}"></th:block>

        <main class="main-content">
            <th:block th:replace="~{admin/fragments/admin-header :: header('Transaksi')}"></th:block>

            <div class="content-area">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon blue">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                    <line x1="1" y1="10" x2="23" y2="10"></line>
                                </svg>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" th:text="${totalTransactions != null ? totalTransactions : 0}">0</div>
                                <div class="stat-label">Total Transaksi</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon green">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" th:text="${paidTransactions != null ? paidTransactions : 0}">0</div>
                                <div class="stat-label">Transaksi Berhasil</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon yellow">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" th:text="${pendingTransactions != null ? pendingTransactions : 0}">0</div>
                                <div class="stat-label">Transaksi Pending</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon green">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="1" x2="12" y2="23"></line>
                                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                </svg>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" th:text="${totalRevenue != null ? 'Rp ' + #numbers.formatInteger(totalRevenue, 3, 'POINT') : 'Rp 0'}">Rp 0</div>
                                <div class="stat-label">Total Pendapatan</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Riwayat Transaksi</h3>
                        <button class="btn btn-outline-secondary btn-sm" onclick="exportTransactions()">Export</button>
                    </div>
                    <div class="card-body">
                        <div class="toolbar">
                            <div class="search-box">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <path d="m21 21-4.3-4.3"></path>
                                </svg>
                                <input type="text" id="transactionSearch" placeholder="Cari kode transaksi..." onkeyup="filterTable('transactionsTable', this.value)">
                            </div>
                            <div class="filter-group">
                                <select class="form-select form-select-sm" id="transactionStatusFilter" onchange="filterByPaymentStatus('transactionsTable', this.value)">
                                    <option value="">Semua Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="paid">Paid</option>
                                    <option value="failed">Failed</option>
                                    <option value="refunded">Refunded</option>
                                </select>
                                <select class="form-select form-select-sm" id="transactionTypeFilter" onchange="filterByType('transactionsTable', this.value)">
                                    <option value="">Semua Tipe</option>
                                    <option value="purchase">Purchase</option>
                                    <option value="topup">Top Up</option>
                                    <option value="refund">Refund</option>
                                </select>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover" id="transactionsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Kode Transaksi</th>
                                        <th>Pengguna</th>
                                        <th>Tipe</th>
                                        <th>Metode</th>
                                        <th>Jumlah</th>
                                        <th>Status</th>
                                        <th>Tanggal</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="trx : ${transactions}" th:data-status="${trx.paymentStatus}" th:data-type="${trx.transactionType}">
                                        <td><strong th:text="${trx.transactionCode}">#TRX001</strong></td>
                                        <td>
                                            <div class="table-user">
                                                <div class="table-avatar" th:text="${#strings.substring(trx.student.firstName, 0, 1)}">U</div>
                                                <div class="table-user-info">
                                                    <div class="table-user-name" th:text="${trx.student.firstName + ' ' + (trx.student.lastName != null ? trx.student.lastName : '')}">Nama</div>
                                                    <div class="table-user-email" th:text="${trx.student.email}">email</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td><span class="badge bg-secondary" th:text="${trx.transactionType}">purchase</span></td>
                                        <td th:text="${trx.paymentMethod}">balance</td>
                                        <td th:text="'Rp ' + ${#numbers.formatInteger(trx.amount, 3, 'POINT')}">Rp 0</td>
                                        <td><span class="status-badge" th:classappend="${trx.paymentStatus == 'paid' ? 'published' : 'draft'}" th:text="${trx.paymentStatus}">status</span></td>
                                        <td th:text="${#temporals.format(trx.createdAt, 'dd MMM yyyy')}">01 Jan 2025</td>
                                        <td>
                                            <div class="action-btns">
                                                <button class="action-btn" th:onclick="'viewTransaction(' + ${trx.id} + ')'" title="Detail">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                                        <circle cx="12" cy="12" r="3"></circle>
                                                    </svg>
                                                </button>
                                                <button class="action-btn edit" th:if="${trx.paymentStatus == 'pending'}" th:onclick="'updateTransactionStatus(' + ${trx.id} + ')'" title="Update">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr th:if="${transactions == null || transactions.isEmpty()}">
                                        <td colspan="8" class="text-center py-4 text-muted">Belum ada transaksi</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <nav th:if="${totalPages != null && totalPages > 1}">
                            <ul class="pagination justify-content-center mb-0">
                                <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                                    <a class="page-link" th:href="@{/admin/transactions(page=${currentPage - 1})}">Sebelumnya</a>
                                </li>
                                <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}" th:classappend="${i == currentPage} ? 'active'">
                                    <a class="page-link" th:href="@{/admin/transactions(page=${i})}" th:text="${i + 1}">1</a>
                                </li>
                                <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                                    <a class="page-link" th:href="@{/admin/transactions(page=${currentPage + 1})}">Selanjutnya</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <th:block th:replace="~{admin/fragments/admin-header :: notifications}"></th:block>

    <!-- Transaction Status Modal -->
    <div class="modal-overlay" id="transactionStatusModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Update Status Transaksi</h3>
                <button class="modal-close" onclick="closeModal('transactionStatusModal')">X</button>
            </div>
            <div class="modal-body">
                <form id="transactionStatusForm">
                    <input type="hidden" id="transactionStatusId">
                    <div class="mb-3">
                        <label class="form-label">Status Pembayaran</label>
                        <select class="form-select" id="transactionStatusValue">
                            <option value="pending">Pending</option>
                            <option value="paid">Paid</option>
                            <option value="failed">Failed</option>
                            <option value="refunded">Refunded</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Catatan</label>
                        <textarea class="form-control" id="transactionNotes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-secondary" onclick="closeModal('transactionStatusModal')">Batal</button>
                <button class="btn btn-primary" onclick="saveTransactionStatus()">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Transaction Detail Modal -->
    <div class="modal-overlay" id="transactionDetailModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Detail Transaksi</h3>
                <button class="modal-close" onclick="closeModal('transactionDetailModal')">X</button>
            </div>
            <div class="modal-body" id="transactionDetailContent"></div>
            <div class="modal-footer">
                <button class="btn btn-outline-secondary" onclick="closeModal('transactionDetailModal')">Tutup</button>
            </div>
        </div>
    </div>

    <th:block th:replace="~{admin/fragments/admin-modals :: toastContainer}"></th:block>

    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/js/admin-common.js}"></script>
    <script>
        function viewTransaction(transactionId) {
            fetch('/api/admin/transactions/' + transactionId)
                .then(r => r.json())
                .then(data => {
                    let itemsHtml = '';
                    if (data.items && data.items.length > 0) {
                        itemsHtml = '<div class="mb-3"><label class="text-muted small">Item</label><ul class="list-group">';
                        data.items.forEach(item => {
                            itemsHtml += '<li class="list-group-item d-flex justify-content-between"><span>' + item.course.title + '</span><span>Rp ' + new Intl.NumberFormat('id-ID').format(item.price) + '</span></li>';
                        });
                        itemsHtml += '</ul></div>';
                    }
                    document.getElementById('transactionDetailContent').innerHTML = 
                        '<div class="mb-3"><label class="text-muted small">Kode</label><div class="fw-bold">' + data.transactionCode + '</div></div>' +
                        '<div class="row mb-3"><div class="col-6"><label class="text-muted small">Pengguna</label><div>' + data.student.firstName + ' ' + (data.student.lastName || '') + '</div></div>' +
                        '<div class="col-6"><label class="text-muted small">Status</label><div><span class="status-badge ' + (data.paymentStatus === 'paid' ? 'published' : 'draft') + '">' + data.paymentStatus + '</span></div></div></div>' +
                        '<div class="mb-3"><label class="text-muted small">Jumlah</label><div class="fs-4 fw-bold text-primary">Rp ' + new Intl.NumberFormat('id-ID').format(data.amount) + '</div></div>' +
                        itemsHtml;
                    openModal('transactionDetailModal');
                })
                .catch(() => showToast('Gagal memuat detail', 'error'));
        }

        function updateTransactionStatus(transactionId) {
            document.getElementById('transactionStatusId').value = transactionId;
            openModal('transactionStatusModal');
        }

        function saveTransactionStatus() {
            const id = document.getElementById('transactionStatusId').value;
            fetch('/api/admin/transactions/' + id + '/status', { 
                method: 'PUT', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ status: document.getElementById('transactionStatusValue').value, notes: document.getElementById('transactionNotes').value }) 
            }).then(r => { 
                if (r.ok) { showToast('Status berhasil diubah', 'success'); closeModal('transactionStatusModal'); setTimeout(() => location.reload(), 1000); } 
                else showToast('Gagal mengubah status', 'error'); 
            });
        }

        function filterByPaymentStatus(tableId, status) {
            document.querySelectorAll('#' + tableId + ' tbody tr').forEach(row => {
                row.style.display = !status || row.getAttribute('data-status') === status ? '' : 'none';
            });
        }

        function filterByType(tableId, type) {
            document.querySelectorAll('#' + tableId + ' tbody tr').forEach(row => {
                row.style.display = !type || row.getAttribute('data-type') === type ? '' : 'none';
            });
        }

        function exportTransactions() {
            window.location.href = '/api/admin/transactions/export';
        }
    </script>
</body>
</html>
